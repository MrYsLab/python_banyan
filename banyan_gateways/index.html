


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-5.1.6">
    
    
      
        <title>An Introduction To OneGPIO Gateways - Python Banyan</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.4b9ffd7b.min.css">
      
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#understanding-the-gatewaybase-class" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href=".." title="Python Banyan" class="md-header-nav__button md-logo" aria-label="Python Banyan">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Python Banyan
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              An Introduction To OneGPIO Gateways
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Python Banyan" class="md-nav__button md-logo" aria-label="Python Banyan">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Python Banyan
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Welcome" class="md-nav__link">
      Welcome
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      User's Guide
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="User's Guide" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        User's Guide
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../users_guide/" title="What Is Python Banyan?" class="md-nav__link">
      What Is Python Banyan?
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../install/" title="Installation" class="md-nav__link">
      Installation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../examples_intro/" title="Introduction To The Tutorials" class="md-nav__link">
      Introduction To The Tutorials
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../api/" title="Base Class API Reference" class="md-nav__link">
      Base Class API Reference
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../example1/" title="Tutorial 1 - A Simple Echo Server/Client" class="md-nav__link">
      Tutorial 1  - A Simple Echo Server/Client
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../example2/" title="Tutorial 2 - Adding Command Line Options To A Component" class="md-nav__link">
      Tutorial 2  - Adding Command Line Options To A Component
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../example3/" title="Tutorial 3 - Distributed Applications" class="md-nav__link">
      Tutorial 3  - Distributed Applications
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../example4/" title="Tutorial 4 - Applications From Components On Differing Platforms" class="md-nav__link">
      Tutorial 4  - Applications From Components On Differing Platforms
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../example5/" title="Tutorial 5 - Debugging Using The Monitor" class="md-nav__link">
      Tutorial 5  - Debugging Using The Monitor
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../example6/" title="Tutorial 6 - Integrating With A GUI Event Loop" class="md-nav__link">
      Tutorial 6  - Integrating With A GUI Event Loop
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../example7/" title="Tutorial 7 - Installing Components As Executable Modules" class="md-nav__link">
      Tutorial 7  - Installing Components As Executable Modules
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../example8/" title="Tutorial 8 - Using the Banyan Launcher" class="md-nav__link">
      Tutorial 8  - Using the Banyan Launcher
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../example9/" title="Tutorial 9 - Connecting To Multiple Backplanes" class="md-nav__link">
      Tutorial 9  - Connecting To Multiple Backplanes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../example10/" title="Tutorial 10 - Connecting Banyan To An MQTT Network" class="md-nav__link">
      Tutorial 10 - Connecting Banyan To An MQTT Network
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../example11/" title="Tutorial 11 - Physical Computing And GPIO" class="md-nav__link">
      Tutorial 11 - Physical Computing And GPIO
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../benchmark/" title="Comparing Banyan and MQTT" class="md-nav__link">
      Comparing Banyan and MQTT
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../about/" title="About" class="md-nav__link">
      About
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      The OneGPIO Project
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="The OneGPIO Project" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        The OneGPIO Project
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../gpio_intro/" title="Introducing OneGPIO" class="md-nav__link">
      Introducing OneGPIO
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../common_messaging_protocol/" title="The OneGPIO Messaging Protocol" class="md-nav__link">
      The OneGPIO Messaging Protocol
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        An Introduction To OneGPIO Gateways
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg>
        </span>
      </label>
    
    <a href="./" title="An Introduction To OneGPIO Gateways" class="md-nav__link md-nav__link--active">
      An Introduction To OneGPIO Gateways
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#understanding-the-gatewaybase-class" class="md-nav__link">
    Understanding The GatewayBase Class
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#some-specific-command-examples" class="md-nav__link">
    Some Specific Command Examples
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adding-a-custom-spin-to-the-command" class="md-nav__link">
    Adding A Custom Spin To The Command
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adding-some-more-spin" class="md-nav__link">
    Adding Some More Spin
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../additional_gateways/" title="Additional Banyan Gateways" class="md-nav__link">
      Additional Banyan Gateways
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../one_gpio_demos/" title="OneGPIO Demos" class="md-nav__link">
      OneGPIO Demos
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#understanding-the-gatewaybase-class" class="md-nav__link">
    Understanding The GatewayBase Class
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#some-specific-command-examples" class="md-nav__link">
    Some Specific Command Examples
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adding-a-custom-spin-to-the-command" class="md-nav__link">
    Adding A Custom Spin To The Command
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adding-some-more-spin" class="md-nav__link">
    Adding Some More Spin
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  
                
                
                  <h1>An Introduction To OneGPIO Gateways</h1>
                
                <p>A <em>OneGPIO Gateway</em> is a specialized Banyan component that is target-hardware specific. 
 It subscribes to and translates OneGPIO command messages to and from native target hardware 
 GPIO API calls. OneGPIO Gateways for the <a href="https://github.com/MrYsLab/python_banyan/blob/master/projects/OneGPIO/arduino_uno/arduino_gateway.py">Arduino</a>, 
<a href="https://github.com/MrYsLab/python_banyan/blob/master/projects/OneGPIO/esp_8266/esp8266_gateway.py">ESP-8266,</a>
 and <a href="https://github.com/MrYsLab/python_banyan/blob/master/projects/OneGPIO/raspberry_pi/rpi_gateway.py">Raspberry Pi</a> are included with this distribution.</p>
<p>A base class, called
<a href="https://github.com/MrYsLab/python_banyan/blob/master/python_banyan/gateway_base/gateway_base.py"><strong><em>GatewayBase,</em></strong></a>
is made available to simplify creating a OneGPIO Gateway. This class encapsulates both BanyanBase functionality as well as
OneGPIO Gateway functionality. When implementing a OneGPIO Gateway, you may choose
any target GPIO API. For example, in creating the Raspberry Pi Gateway, the <em>pigpio</em> library
was chosen. If you prefer to use some other API, there are no restrictions to do so.</p>
<p>There is also a Python asyncio version of the base class, called
 <a href="https://github.com/MrYsLab/python_banyan/blob/master/python_banyan/gateway_base_aio/gateway_base_aio.py"><strong><em>GatewayBaseAIO</em></strong>.</a>
 This additional base class
was necessary to support the pymata-express asyncio GPIO library for the Arduino. It is very
similar to the GatewayBase class, and so it will not be discussed here.</p>
<h2 id="understanding-the-gatewaybase-class">Understanding The GatewayBase Class</h2>
<p>Let's look at the <a href="https://github.com/MrYsLab/python_banyan/blob/master/python_banyan/gateway_base/gateway_base.py">code.</a> 
Below are code sections that are followed by a discussion. </p>
<pre><code>    23  from python_banyan.banyan_base import BanyanBase
    24  
    25  
    26  class GatewayBase(BanyanBase):
    27      &quot;&quot;&quot;
    28      This class provides a common front end abstraction for all asyncio hardware gateways.
    29      &quot;&quot;&quot;
    30  
    31      # pin modes
    32      DIGITAL_INPUT_MODE = 0
    33      DIGITAL_OUTPUT_MODE = 1
    34      PWM_OUTPUT_MODE = 2
    35      ANALOG_INPUT_MODE = 3
    36      ANALOG_OUTPUT_MODE = 4
    37      DIGITAL_INPUT_PULLUP_MODE = 5
    38      I2C_MODE = 6
    39      TONE_MODE = 7
    40      SERVO_MODE = 8
    41      STEPPER_MODE = 9
    42      SONAR_MODE = 10
    43      WILD_CARD_MODE = 11
    44  
    45      # board types
    46      ARDUINO = 0
    47      RPi = 1
    48      ESP8266 = 2
</code></pre>

<p>Since GatewayBase is derived by the BanyanBase class, we import BanyanBase on line
23. </p>
<p>Lines 31-43 define a set of pin mode "constants" as class variables.</p>
<p>Lines 46-48 define some common board type identifiers.</p>
<pre><code>    51      def __init__(self, back_plane_ip_address=None, subscriber_port='43125',
    52                   publisher_port='43124', process_name='',
    53                   subscriber_list=None, board_type=None, ):
    54          &quot;&quot;&quot;
    55  
    56          :param back_plane_ip_address: banyan_base back_planeIP Address -
    57                 if not specified, it will be set to the local computer
    58          :param subscriber_port: banyan_base back plane subscriber port.
    59                 This must match that of the banyan_base backplane
    60          :param publisher_port: banyan_base back plane publisher port.
    61                                 This must match that of the banyan_base
    62                                 backplane
    63          :param process_name: Component identifier
    64          :param subscriber_list: a tuple or list of topics to be subscribed to
    65          :param board_type: micro-controller type ID
    66  
    67          &quot;&quot;&quot;
</code></pre>

<p>The __init__ method accepts the standard BanyanBase input parameters, as well
as 2 additional  parameters. The <em>subscriber_list</em> parameter allows the user
to supply a list of subscription topics for the gateway, and <em>board_type</em> is an optional
parameter that will allow the user to supply a board type id.</p>
<pre><code>    68          if board_type:
    69              self.board_type = board_type
    70  
    71          if subscriber_list:
    72              self.subscriber_list = subscriber_list
    73          else:
    74              self.subscriber_list = ('all')
    75  
    76          # dictionaries for pin modes set by user
    77          # an entry is board type specific
    78  
    79          # this dictionary initially contains an entry for each default
    80          # digital input pin
    81  
    82          self.pins_dictionary = {}
    83  
    84          # a pin can optionally be given a tag, it is used as a key to find
    85          # pin number
    86          # tag(string): pin(integer)
    87          self.tags_dictionary = {}
    88  
    89          self.init_pins_dictionary()
    90  
</code></pre>

<p>In this section, we save the input parameters and establish some data structures.</p>
<p>On line 74, if a subscriber_list was not provided, a default subscription  topic of <em>all</em>
is used as the lone entry into the subscriber_list. Of course, subscription
topics may be added at any time during run-time.</p>
<p>Line 82 creates an empty <em>pins_dictionary</em>. This dictionary is used by each
hardware-specific gateway to store pin information, such as the pin's mode and current state.</p>
<p>Line 87 creates an empty <em>tags_dictionary</em>. When setting a pin mode, if a tag is provided,
an entry is made into this dictionary. The tag is used as a key, and the pin number is the entry's value.</p>
<p>Line 89 calls the <em>init_pins_dictionary</em> method. See the discussion below for line 126 for
more information about this method.</p>
<pre><code>    91          # initialize the parent
    92          super(GatewayBase, self).__init__(back_plane_ip_address=back_plane_ip_address,
    93                                            subscriber_port=subscriber_port,
    94                                            publisher_port=publisher_port,
    95                                            process_name=process_name,
    96                                            )
</code></pre>

<p>Line 91 initializes the BanyanBase class</p>
<pre><code>    98          self.command_dictionary = {'analog_write': self.analog_write,
    99                                     'digital_write': self.digital_write,
   100                                     'disable_analog_reporting': self.disable_analog_reporting,
   101                                     'disable_digital_reporting': self.disable_digital_reporting,
   102                                     'enable_analog_reporting': self.disable_analog_reporting,
   103                                     'enable_digital_reporting': self.disable_digital_reporting,
   104                                     'i2c_read': self.i2c_read,
   105                                     'i2c_write': self.i2c_write,
   106                                     'play_tone': self.play_tone,
   107                                     'pwm_write': self.pwm_write,
   108                                     'servo_position': self.servo_position,
   109                                     'set_mode_analog_input': self.set_mode_analog_input,
   110                                     'set_mode_digital_input': self.set_mode_digital_input,
   111                                     'set_mode_digital_input_pullup': self.set_mode_digital_input_pullup,
   112                                     'set_mode_digital_output': self.set_mode_digital_output,
   113                                     'set_mode_i2c': self.set_mode_i2c,
   114                                     'set_mode_pwm': self.set_mode_pwm,
   115                                     'set_mode_servo': self.set_mode_servo,
   116                                     'set_mode_sonar': self.set_mode_sonar,
   117                                     'set_mode_stepper': self.set_mode_stepper,
   118                                     'set_mode_tone': self.set_mode_tone,
   119                                     'stepper_write': self.stepper_write,
   120                                     }
</code></pre>

<p>Lines 98-120 create a <em>command_dictionary</em>. Every OneGPIO Gateway contains a 
<em>command_dictionary</em>.</p>
<p>The <em>command_dictionary</em> maps
 OneGPIO <em>commands</em> to
methods that ultimately process the command.
A OneGPIO <em>command string</em> is used as a key, and the value for each
key is a method <em>reference</em> that will be called on line 161 below.</p>
<pre><code>   121  
   122          if subscriber_list is not None:
   123              for topic in subscriber_list:
   124                  self.set_subscriber_topic(topic)
</code></pre>

<p>The __init__ method concludes by subscribing to all the topics within the subscriber_list.</p>
<pre><code>   126      def init_pins_dictionary(self):
   127          &quot;&quot;&quot;
   128          This method will initialize the pins dictionary
   129          This is handled within the class for each hardware type
   130          &quot;&quot;&quot;
   131          raise NotImplementedError
</code></pre>

<p>This method <strong><em>must be</em></strong>  overwritten by each hardware-specific OneGPiO Gateway, even if not needed.
This is to ensure that you have not forgotten to implement this method.</p>
<pre><code>   133      def incoming_message_processing(self, topic, payload):
   134          &quot;&quot;&quot;
   135          Messages are sent here from the receive_loop
   136          :param topic: Message Topic string
   137          :param payload: Message Data
   138          :return:
   139          &quot;&quot;&quot;
   140          # process payload command
   141          try:
   142              command = payload['command']
   143          except KeyError:
   144              print(payload)
   145              raise
   146  
   147          # if a tag is provided and the tag is in the dictionary, fetch
   148          # the associated pin number
   149          if 'tag' in payload:
   150              tag = payload['tag']
   151              if tag:
   152                  if tag in self.tags_dictionary:
   153                      pin = self.tags_dictionary[tag]
   154                      # the pin is optional if using tag, so add it to the payload
   155                      payload['pin'] = pin
   156                  else:
   157                      self.tags_dictionary[payload['tag']] = payload['pin']
   158  
   159          # if command is in the command dictionary, execute the command
   160          if command in self.command_dictionary.keys():
   161              self.command_dictionary[command](topic, payload)
   162  
   163          # for unknown requests, pass them along to the hardware gateway to handle
   164          else:
   165              self.additional_banyan_messages(topic, payload)
   166  

</code></pre>

<p>Lines 133-168 implement the Banyan <em>incoming_message_processing</em> method. Received OneGPIO
commands are processed by this method.</p>
<p>Line 141-145 retrieves the <em>command</em> key string of the OneGPIO
incoming message. </p>
<p>Line 149 checks to see if an optional <em>tag</em> key is in the message.</p>
<p>If it is, lines 149-158 process the tag. If the tag is not in the <em>tags_dictionary</em>,
the tag and its associated pin number are added to the dictionary.</p>
<p>Lines 160-165 check to see if the value of the <em>command</em> key is within the command_dictionary.
If it is, the command method is called.</p>
<p>If it is not found, the <em>additional_banyan_messages</em> method is called.
 This allows you to add hardware-specific commands not found in the command dictionary easily.</p>
<pre><code>   179      def analog_write(self, topic, payload):
   180          &quot;&quot;&quot;
   181          This method will pass any messages not handled by this class to the
   182          specific gateway class. Must be overwritten by the hardware gateway class.
   183          :param topic: message topic
   184          :param payload: message payload
   185          &quot;&quot;&quot;
   186          raise NotImplementedError
</code></pre>

<p>The remainder of the class is the set of command methods that need to be overwritten
in the derived class. Lines 179-186 are an illustration of the analog_write method. All the
other command methods follow a similar pattern (lines 170-378).</p>
<h2 id="some-specific-command-examples">Some Specific Command Examples</h2>
<p>To illustrate the flexibility of using the OneGPIO specification, let's look 
at some sample OneGPIO command implementations. Both examples
presented below are from the Raspberry Pi Gateway.</p>
<h2 id="adding-a-custom-spin-to-the-command">Adding A <em>Custom Spin</em> To The Command</h2>
<p>When implementing a OneGPIO command,
you can go beyond a simple one to one mapping between the OneGPIO command and
the underlying GPIO API.</p>
<p>Let's look at <em>set_mode_digital_input</em> for the Raspberry Pi. The Raspberry Pi
Gateway uses the pigpio GPIO library. Of course, you can use
any GPIO library you wish to choose.</p>
<pre><code>   def set_mode_digital_input(self, topic, payload):
        &quot;&quot;&quot;
        This method sets a pin as digital input.
        :param topic: message topic
        :param payload: {&quot;command&quot;: &quot;set_mode_digital_input&quot;, &quot;pin&quot;: “PIN”, &quot;tag&quot;:”TAG” }
        &quot;&quot;&quot;
        pin = payload['pin']
        entry = self.pins_dictionary[pin]
        entry['mode'] = self.DIGITAL_INPUT_MODE

        self.pi.set_glitch_filter(pin, 20000)
        self.pi.set_mode(pin, pigpio.INPUT)
        self.pi.set_pull_up_down(pin, pigpio.PUD_DOWN)

        self.pi.callback(pin, pigpio.EITHER_EDGE, self.input_callback)
</code></pre>

<p>The pin number is extracted from the OneGPIO payload. The pin mode is set within
 the <em>pins_dictionary</em> for the pin.</p>
<p>Next, it performs 4 <em>pigpio</em> functions.</p>
<ul>
<li>A glitch filter to debounce the pin.</li>
<li>The pin mode is set to <strong><em>input</em></strong>.</li>
<li>The internal pull-up/pull-down resistor for the pin is set to <strong><em>pull-down</em></strong>.</li>
<li>A callback method is set. This method is called whenever there is a state change for the pin.</li>
</ul>
<p>The OneGPIO Application Component has no knowledge of all of this underlying logic.
It merely sends the command to set the pin mode to digital input, and the OneGPIO Gateway
interprets the behavior for the specific target hardware.</p>
<h2 id="adding-some-more-spin">Adding Some More <em>Spin</em></h2>
<p>The Raspberry Pi GPIO does not directly support analog input. But
since you control the definition of a command, the gateway
can implement anything you choose, including using an external device to perform analog input.</p>
<p>Here we implement analog input for the Raspberry Pi by using a PFC8591
A/D converter.</p>
<pre><code>    def set_mode_analog_input(self, topic, payload):
        &quot;&quot;&quot;
        This method programs a PCF8591 AD/DA for analog input.
        :param topic: message topic
        :param payload: {&quot;command&quot;: &quot;set_mode_analog_input&quot;,
                         &quot;pin&quot;: “PIN”, &quot;tag&quot;:”TAG” }
        &quot;&quot;&quot;

        # pin is used as channel number

        value = None
        i2c_handle = self.pi.i2c_open(1, 72, 0)
        pin = payload['pin']

        self.pi.i2c_write_byte_data(i2c_handle, 64 | (pin &amp; 0x03), 0)
        time.sleep(0.1)
        for i in range(3):
            value = self.pi.i2c_read_byte(i2c_handle)

        self.pi.i2c_close(i2c_handle)

        # publish an analog input report
        payload = {'report': 'analog_input', 'pin': pin,
                   'value': value}
        self.publish_payload(payload, 'from_rpi_gateway')
</code></pre>

<p>The A/D device is i2c based, and so this method implements the i2c communication.
The method retrieves the current value for one of the 4 channels supported by the
PCF8591 A/D converter. It then publishes that value using a OneGPIO report message.</p>
<p><br>
<br>
Copyright (C) 2017-2020 Alan Yorinks All Rights Reserved</p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../common_messaging_protocol/" title="The OneGPIO Messaging Protocol" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                The OneGPIO Messaging Protocol
              </div>
            </div>
          </a>
        
        
          <a href="../additional_gateways/" title="Additional Banyan Gateways" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Additional Banyan Gateways
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.a0c4167b.min.js"></script>
      <script src="../assets/javascripts/bundle.fb26dd1d.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.37585f48.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>