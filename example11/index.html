<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Tutorial 11 - Physical Computing And GPIO - Python Banyan</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Tutorial 11 - Physical Computing And GPIO";
    var mkdocs_page_input_path = "example11.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Python Banyan</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">User's Guide</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../install/">Installation</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Python Banyan By Example</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../examples_intro/">Introduction</a>
                </li>
                <li class="">
                    
    <a class="" href="../example1/">Tutorial 1  - A Simple Echo Server/Client</a>
                </li>
                <li class="">
                    
    <a class="" href="../example2/">Tutorial 2  - Adding Command Line Options To A Component</a>
                </li>
                <li class="">
                    
    <a class="" href="../example3/">Tutorial 3  - Distributed Applications</a>
                </li>
                <li class="">
                    
    <a class="" href="../example4/">Tutorial 4  - Applications From Components On Differing Platforms</a>
                </li>
                <li class="">
                    
    <a class="" href="../example5/">Tutorial 5  - Debugging Using The Monitor</a>
                </li>
                <li class="">
                    
    <a class="" href="../example6/">Tutorial 6  - Integrating With A GUI Event Loop</a>
                </li>
                <li class="">
                    
    <a class="" href="../example7/">Tutorial 7  - Installing Components As Executable Modules</a>
                </li>
                <li class="">
                    
    <a class="" href="../example8/">Tutorial 8  - Using the Banyan Launcher</a>
                </li>
                <li class="">
                    
    <a class="" href="../example9/">Tutorial 9  - Connecting To Multiple Backplanes</a>
                </li>
                <li class="">
                    
    <a class="" href="../example10/">Tutorial 10 - Connecting Banyan To An MQTT Network</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">Tutorial 11 - Physical Computing And GPIO</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#gpio-control">GPIO Control</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#a-simple-solution">A Simple Solution</a></li>
        
        </ul>
    

    </ul>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../benchmark/">Comparing Banyan and MQTT</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../about/">About</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Python Banyan</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Python Banyan By Example &raquo;</li>
        
      
    
    <li>Tutorial 11 - Physical Computing And GPIO</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="gpio-control">GPIO Control</h1>
<p>In this section we will look at a simple example illustrating
GPIO control of a Raspberry Pi using Python Banyan.</p>
<p>The problem we will solve is this:</p>
<p>When a user presses a mechanical push button, an LED will light up
and a Banyan message will be published. The Banyan message
contains the state change details of the push button -
 the GPIO pin number, the current state of the button and a time
 tick to indicate when the change occurred
 .
When the user releases the pushbutton, the LED will be
extinguished and another message will be published indicating the new state
change.</p>
<p>For ease of use, all examples will use a Raspberry Pi Model 3 connected to
a <a href="http://pibrella.com/">Pibrella</a> hat. The Pibrella has a push button and
several LEDs. This precludes us from have to wire individual components to the
Raspberry Pi.</p>
<p>For GPIO control, the <a href="http://abyz.me.uk/rpi/pigpio/">pigpio</a> GPIO library will
be used.</p>
<h2 id="a-simple-solution">A Simple Solution</h2>
<p>Let's begin by looking at a simple example
named <a href="https://github.com/MrYsLab/python_banyan/blob/master/examples/single.py">single.py</a>.</p>
<h3 id="the-code-line-by-line">The Code Line By Line</h3>
<pre><code> 1  """
 2   Copyright (c) 2016-2019 Alan Yorinks All right reserved.
 3
 4   This program is free software; you can redistribute it and/or
 5   modify it under the terms of the GNU AFFERO GENERAL PUBLIC LICENSE
 6   Version 3 as published by the Free Software Foundation; either
 7   or (at your option) any later version.
 8   This library is distributed in the hope that it will be useful,
 9   but WITHOUT ANY WARRANTY; without even the implied warranty of
10   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
11   General Public License for more details.
12
13   You should have received a copy of the GNU AFFERO GENERAL PUBLIC LICENSE
14   along with this library; if not, write to the Free Software
15   Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
16
17  """
18
19  import sys
20
21  import pigpio
22
23  from python_banyan.banyan_base import BanyanBase
24
25
26  class Single(BanyanBase):
27      """
28      This class will monitor a push button connected to a
29      Raspberry Pi. When the button is pressed, an LED will light,
30      and message will be published with changed state of the input pin.
31      """
32
33      def __init__(self, push_button=11, led=4, publish_topic='button'):
34          """
35          This method initialize the class for operation
36          :param push_button: push_button pin
37          :param led: led pin
38          :param publish_topic: publishing topic
39          """
40
41          # initialize the parent
42          super(Single, self).__init__(process_name='Single')
43
44          # make the input parameters available to the entire class
45          self.push_button = push_button
46          self.led = led
47          self.publish_topic = publish_topic
48
49          # initialize the GPIO pins using pigpio
50          self.pi = pigpio.pi()
51          self.pi.set_mode(self.push_button, pigpio.INPUT)
52          self.pi.set_pull_up_down(self.push_button, pigpio.PUD_DOWN)
53          self.pi.set_mode(led, pigpio.OUTPUT)
54
55          # set a glitch filter to debounce the switch
56          self.pi.set_glitch_filter(push_button, 100)
57
58          # set a callback for when the button is pressed
59          self.pi.callback(self.push_button, pigpio.EITHER_EDGE,
60                           self.button_callback)
61
62          # this will keep the program running forever
63          try:
64              self.receive_loop()
65          except KeyboardInterrupt:
66              sys.exit(0)
67
68      def button_callback(self, gpio, level, tick):
69          """
70          This method receives a change in state of the
71          pushbutton.
72
73          It will print the current state to the console
74          and reflect that state by turning the LED on
75          or OFF based on the state.
76
77          It will also publish a message containing the state
78          change.
79
80          :param gpio: pin number
81          :param level: pin level
82          :param tick: timer tick
83          """
84          print('The pushbutton state is {} on pin {} '
85                'and changed at tick {}'.format(level, gpio, tick))
86
87          self.pi.write(self.led, level)
88
89          # create a publishing payload
90          payload = {'pushbutton state': level, 'gpio_pin': gpio,
91                     'time_tick':tick}
92          self.publish_payload(payload, self.publish_topic)
93
94
95  Single()
</code></pre>
<p>Line 21 imports the pigpio library.</p>
<p>Lines 49 through 60 set the pin mode for both the push button
and the LED.</p>
<p>Note: The pibrella requires that the pull-down resistor be enabled on the
Raspberry Pi. Line 52 enables the pull-down resistor.</p>
<p>A "glitch" filter is set on line 56 to prevent the push button from
generating multiple events from a single press or release of the
button.</p>
<p>Line 59 establishes a callback for when the button is either
pressed or released.</p>
<p>Line 64 calls the base class receive_loop method that will
keep the loop running until the user quits the program.</p>
<p>The callback method is contained in lines 68 through 92.</p>
<p>When the user presses or releases the pushbutton this method will be
called by pigpio.</p>
<p>Lines 84 and 85 print a message to the console containing the
parameters passed by pigpio to this method.</p>
<p>On line 87 the LED is set to the reported state, and finally
lines 89-92 create and publish a Banyan message about the push button
event.</p>
<p>Here is the output on the console after pressing and releasing the
button twice:</p>
<pre><code>python3 single.py

************************************************************
Single using Back Plane IP address: 192.168.2.192
Subscriber Port = 43125
Publisher  Port = 43124
Loop Time = 0.1 seconds
************************************************************
The pushbutton state is 1 on pin 11 and changed at tick 3856477239
The pushbutton state is 0 on pin 11 and changed at tick 3857470672
The pushbutton state is 1 on pin 11 and changed at tick 3858747310
The pushbutton state is 0 on pin 11 and changed at tick 3859867653
</code></pre>

<p>And here is the output from a Monitor session as the button is pressed
and released.</p>
<pre><code>$ monitor

************************************************************
Monitor using Back Plane IP address: 192.168.2.192
Subscriber Port = 43125
Publisher  Port = 43124
Loop Time = 0.1 seconds
************************************************************
button {'time_tick': 3856477239, 'pushbutton state': 1, 'gpio_pin': 11}
button {'time_tick': 3857470672, 'pushbutton state': 0, 'gpio_pin': 11}
button {'time_tick': 3858747310, 'pushbutton state': 1, 'gpio_pin': 11}
button {'time_tick': 3859867653, 'pushbutton state': 0, 'gpio_pin': 11}
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../benchmark/" class="btn btn-neutral float-right" title="Comparing Banyan and MQTT">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../example10/" class="btn btn-neutral" title="Tutorial 10 - Connecting Banyan To An MQTT Network"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../example10/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../benchmark/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
