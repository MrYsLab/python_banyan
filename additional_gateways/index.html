
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.2.15">
    
    
      
        <title>Additional Banyan Gateways - Python Banyan</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.c382b1dc.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.cc9b2e1e.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#mqtt-gateway" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Python Banyan" class="md-header__button md-logo" aria-label="Python Banyan" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Python Banyan
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Additional Banyan Gateways
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Python Banyan" class="md-nav__button md-logo" aria-label="Python Banyan" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Python Banyan
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Welcome
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          User's Guide
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="User's Guide" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          User's Guide
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../users_guide/" class="md-nav__link">
        What Is Python Banyan?
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../install/" class="md-nav__link">
        Installation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../examples_intro/" class="md-nav__link">
        Introduction To The Tutorials
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../api/" class="md-nav__link">
        Base Class API Reference
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../example1/" class="md-nav__link">
        Tutorial 1  - A Simple Echo Server/Client
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../example2/" class="md-nav__link">
        Tutorial 2  - Adding Command Line Options To A Component
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../example3/" class="md-nav__link">
        Tutorial 3  - Distributed Applications
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../example4/" class="md-nav__link">
        Tutorial 4  - Applications From Components On Differing Platforms
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../example5/" class="md-nav__link">
        Tutorial 5  - Debugging Using The Monitor
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../example6/" class="md-nav__link">
        Tutorial 6  - Integrating With A GUI Event Loop
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../example7/" class="md-nav__link">
        Tutorial 7  - Installing Components As Executable Modules
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../example8/" class="md-nav__link">
        Tutorial 8  - Using the Banyan Launcher
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../example9/" class="md-nav__link">
        Tutorial 9  - Connecting To Multiple Backplanes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../example10/" class="md-nav__link">
        Tutorial 10 - Connecting Banyan To An MQTT Network
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../example11/" class="md-nav__link">
        Tutorial 11 - Physical Computing And GPIO
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../benchmark/" class="md-nav__link">
        Comparing Banyan and MQTT
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../about/" class="md-nav__link">
        About
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          The OneGPIO Project
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="The OneGPIO Project" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          The OneGPIO Project
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../gpio_intro/" class="md-nav__link">
        Introducing OneGPIO
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../common_messaging_protocol/" class="md-nav__link">
        The OneGPIO Messaging Protocol
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../banyan_gateways/" class="md-nav__link">
        An Introduction To OneGPIO Gateways
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Additional Banyan Gateways
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Additional Banyan Gateways
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#mqtt-gateway" class="md-nav__link">
    MQTT Gateway
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#websocket-gateway" class="md-nav__link">
    WebSocket Gateway
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a-quick-overview-of-the-wsgateway-component" class="md-nav__link">
    A Quick Overview Of The WsGateway Component
  </a>
  
    <nav class="md-nav" aria-label="A Quick Overview Of The WsGateway Component">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a-quick-look-at-the-wsgateway-internals" class="md-nav__link">
    A Quick Look At The WsGateway Internals
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tcp-gateway" class="md-nav__link">
    TCP Gateway
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../one_gpio_demos/" class="md-nav__link">
        OneGPIO Demos
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#mqtt-gateway" class="md-nav__link">
    MQTT Gateway
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#websocket-gateway" class="md-nav__link">
    WebSocket Gateway
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a-quick-overview-of-the-wsgateway-component" class="md-nav__link">
    A Quick Overview Of The WsGateway Component
  </a>
  
    <nav class="md-nav" aria-label="A Quick Overview Of The WsGateway Component">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a-quick-look-at-the-wsgateway-internals" class="md-nav__link">
    A Quick Look At The WsGateway Internals
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tcp-gateway" class="md-nav__link">
    TCP Gateway
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


  <h1>Additional Banyan Gateways</h1>

<h2 id="mqtt-gateway">MQTT Gateway</h2>
<p>If you need to interconnect with MQTT, a Banyan MQTT Gateway has been provided.
This gateway has been documented <a href="../example10/">here.</a></p>
<h2 id="websocket-gateway">WebSocket Gateway</h2>
<p>The OneGPIO Demo Examples include Web pages to control an
Arduino, ESP-8266, and Raspberry Pi. The WebPages publish
commands via a WebSocket connection. This gateway translates
the WebSocket command messages to OneGPIO command messages. It also translates OneGPIO
reporter messages to WebSocket reporter messages to allow reports
to be displayed on the Web page.</p>
<p>The WebSocket IP address that this component uses is <em>localhost</em> since it is intended to be
used in conjunction with a Web Browser running on the same computer as the Gateway.
The WebSocket IP port is fixed to a value of 9000. If you need to, you can modify the
supplied code to allow the user to modify these values on the command line.</p>
<p><strong><em>IMPORTANT NOTE</em></strong></p>
<p>The WebSocket Gateway utilizes a Python asyncio WebSocket library.
It requires that Python 3.7 or higher be used.</p>
<h2 id="a-quick-overview-of-the-wsgateway-component">A Quick Overview Of The WsGateway Component</h2>
<p>The Banyan WebSocket Gateway is an executable Banyan component. It follows the
command line patterns exposed in the Banyan User's Guide:</p>
<pre><code>usage: ws_gateway.py [-h]
                     [-b BACK_PLANE_IP_ADDRESS]
                     [-m SUBSCRIPTION_LIST [SUBSCRIPTION_LIST ...]]
                     [-n PROCESS_NAME] [-p PUBLISHER_PORT]
                     [-s SUBSCRIBER_PORT]

optional arguments:
  -h, --help            show this help message and exit
  -b BACK_PLANE_IP_ADDRESS
                        None or IP address used by Back Plane
  -m SUBSCRIPTION_LIST [SUBSCRIPTION_LIST ...]
                        A space delimited list of topics
  -n PROCESS_NAME       Set process name in banner
  -p PUBLISHER_PORT     Publisher IP port
  -s SUBSCRIBER_PORT    Subscriber IP port
</code></pre>
<h3 id="a-quick-look-at-the-wsgateway-internals">A Quick Look At The WsGateway Internals</h3>
<p>Once again, a block of code will be presented, followed by a discussion.</p>
<pre><code>    24  import argparse
    25  import asyncio
    26  import datetime
    27  import json
    28  import signal
    29  import sys
    30  
    31  import websockets
    32  
    33  from python_banyan.banyan_base_aio import BanyanBaseAIO
    34  
    35  
    36  class WsGateway(BanyanBaseAIO):
    37      &quot;&quot;&quot;
    38      This class is a gateway between a websocket client and the
    39      Banyan network.
    40  
    41      NOTE: This class requires Python 3.7 or above.
    42  
    43      It implements a websocket server. A websocket client, upon
    44      connection, must send an id message e.g.: {&quot;id&quot;: &quot;to_arduino&quot;}.
    45  
    46      The id will be used as the topic to publish data to the banyan
    47      network.
    48      &quot;&quot;&quot;
    49  
    50      def __init__(self, *subscription_list, back_plane_ip_address=None,
    51                   subscriber_port='43125',
    52                   publisher_port='43124', process_name='WebSocketGateway',
    53                   event_loop=None):
    54          &quot;&quot;&quot;
    55          These are all the normal base class parameters
    56          :param subscription_list:
    57          :param back_plane_ip_address:
    58          :param subscriber_port:
    59          :param publisher_port:
    60          :param process_name:
    61          :param event_loop:
    62          &quot;&quot;&quot;
    63  
    64          # initialize the base class
    65          super(WsGateway, self).__init__(subscriber_list=subscription_list,
    66                                          back_plane_ip_address=back_plane_ip_address,
    67                                          subscriber_port=subscriber_port,
    68                                          publisher_port=publisher_port,
    69                                          process_name=process_name,
    70                                          event_loop=event_loop)
    71          # save the event loop
    72          self.event_loop = event_loop
    73  
    74          # array of active sockets
    75          self.active_sockets = []
    76  
    77          try:
    78              # start the websocket server and call the main task, wsg
    79              self.start_server = websockets.serve(self.wsg, '127.0.0.1', 9000)
    80              self.event_loop.run_until_complete(self.start_server)
    81              self.event_loop.run_forever()
    82          except (websockets.exceptions.ConnectionClosed,
    83                  RuntimeError,
    84                  KeyboardInterrupt):
    85              sys.exit()
</code></pre>
<p>In this section of code, the necessary packages are imported and we
define the WsGateway class, which is derived from BanyanBaseAIO.</p>
<p>Being an asyncio based class, one of the parameters 
that may be passed to this class is an asyncio event loop. Usually,
the default event loop is used, but you can supply your own event loop
if you need to.</p>
<p>This component implements a WebSocket server that permits connections to multiple
WebSocket clients. An empty array, <em>self.active_sockets</em> is created
on line 75 to store a record for each connected socket.</p>
<p>Lines 79-85 start the WebSocket server. When a client connects
to the WebSocket server, the <em>wsg</em> method is called
on line 79.</p>
<p>For information about the WebSocket server, please go to this
<a href="https://github.com/aaugustin/websockets">link</a>.</p>
<pre><code>    87    async def wsg(self, websocket, path):
    88          &quot;&quot;&quot;
    89          This method handles connections and will be used to send
    90          messages to the client
    91          :param websocket: websocket for connected client
    92          :param path: required, but unused
    93          :return:
    94          &quot;&quot;&quot;
    95          # start up banyan
    96          await self.begin()
    97  
    98          # wait for a connection
    99          data = await websocket.recv()
   100  
   101          # expecting an id string from client
   102          data = json.loads(data)
   103  
   104          # if id field not present then raise an exception
   105          try:
   106              id_string = data['id']
   107          except KeyError:
   108              print('Client did not provide an ID string')
   109              raise
   110  
   111          # create a subscriber string from the id
   112          subscriber_string = id_string.replace('to', 'from')
   113  
   114          # subscribe to that topic
   115          await self.set_subscriber_topic(subscriber_string)
   116  
   117          # add an entry into the active_sockets table
   118          entry = {websocket: 'to_banyan_topic', subscriber_string: websocket}
   119          self.active_sockets.append(entry)
   120  
   121          # create a task to receive messages from the client
   122          await asyncio.create_task(self.receive_data(websocket, data['id']))
</code></pre>
<p>The <em>wsg</em> method is called when a WebSocket client connects to the WebSocket Gateway.
Line 96 establishes the zeromq subscriber and publisher sockets for this component
 as well as providing a connection to the Banyan Backplane.</p>
<p>Line 99 waits to receive initial identification data from a WebSocket client. This data 
is used to create a subscription topic for the WebSocket Gateway. </p>
<p>Using the <a href="https://github.com/MrYsLab/python_banyan/blob/master/projects/OneGPIO/arduino_uno/arduino.html">Arduino Demo Station Page</a> 
as an example, the ID string sent as a WebSocket message from the Web page is "to_arduino_gateway." This
ID string is used to create subscription topic strings that the WebSocket Gateway
 uses for its operation. This is accomplished on lines 112-115.</p>
<p>An entry for the socket connection is created and added to the active_websockets array.
The entry is used to dispatch messages to the correct WebSocket during data transfer. This is
accomplished on lines 118-119.</p>
<p>Line 122 creates an asyncio task to continuously receive WebSocket messages from any connected WebSocket client.
 This task passes these messages to the <em>receive_data</em> method
for further processing.</p>
<pre><code>   124      async def receive_data(self, websocket, publisher_topic):
   125          &quot;&quot;&quot;
   126          This method processes a received WebSocket command message
   127          and translates it to a Banyan command message.
   128          :param websocket: The currently active websocket
   129          :param publisher_topic: The publishing topic
   130          &quot;&quot;&quot;
   131          while True:
   132              try:
   133                  data = await websocket.recv()
   134                  data = json.loads(data)
   135              except (websockets.exceptions.ConnectionClosed, TypeError):
   136                  # remove the entry from active_sockets
   137                  # using a list comprehension
   138                  self.active_sockets = [entry for entry in self.active_sockets if websocket not in entry]
   139                  break
   140  
   141              await self.publish_payload(data, publisher_topic)
</code></pre>
<p>The <em>receive_data</em> method processes WebSocket messages sent from the WebSocket client.
The message is in the form of a JSON message and it is decoded on line 134. The message
is then published as a Banyan OneGPIO message on line 141. </p>
<pre><code>   143      async def incoming_message_processing(self, topic, payload):
   144          &quot;&quot;&quot;
   145          This method converts the incoming messages to ws messages
   146          and sends them to the ws client
   147  
   148          :param topic: Message Topic string.
   149  
   150          :param payload: Message Data.
   151          &quot;&quot;&quot;
   152          if 'timestamp' in payload:
   153              timestamp = datetime.datetime.fromtimestamp(payload['timestamp']).strftime('%Y-%m-%d %H:%M:%S')
   154              payload['timestamp'] = timestamp
   155  
   156          ws_data = json.dumps(payload)
   157  
   158          # find the websocket of interest by looking for the topic in
   159          # active_sockets
   160          for socket in self.active_sockets:
   161              if topic in socket.keys():
   162                  pub_socket = socket[topic]
   163                  await pub_socket.send(ws_data)
   164                  # print(ws_data)
</code></pre>
<p>The <em>incoming_message_processing</em> method is the standard Banyan message
processing method, overwritten to process OneGPIO messages received from
the target hardware in the form of a report message. Using the topic
of the message as a key, it looks up the associated WebSocket in the 
<em>active_sockets</em> array and publishes the message to the correct WebSocket.</p>
<p>On lines 152-154, if the gateway provided a timestamp, the timestamp
 is formatted and appended to the report message.
Line 156 encodes the message as a JSON message and sends the message
to the WebSocket client on line 163.</p>
<pre><code>   167  def ws_gateway():
   168      # allow user to bypass the IP address auto-discovery. This is necessary if the component resides on a computer
   169      # other than the computing running the backplane.
   170  
   171      parser = argparse.ArgumentParser()
   172      parser.add_argument(&quot;-b&quot;, dest=&quot;back_plane_ip_address&quot;, default=&quot;None&quot;,
   173                          help=&quot;None or IP address used by Back Plane&quot;)
   174      # allow the user to specify a name for the component and have it shown on the console banner.
   175      # modify the default process name to one you wish to see on the banner.
   176      # change the default in the derived class to set the name
   177      parser.add_argument(&quot;-m&quot;, dest=&quot;subscription_list&quot;, default=&quot;from_arduino_gateway, &quot;
   178                                                                  &quot;from_ESP8266_gateway, &quot;
   179                                                                  &quot;from_rpi_gateway, &quot;
   180                                                                  &quot;from_microbit_gateway&quot;, nargs='+',
   181                          help=&quot;A space-delimited list of topics&quot;)
   182      parser.add_argument(&quot;-n&quot;, dest=&quot;process_name&quot;, default=&quot;WebSocket Gateway&quot;,
   183                          help=&quot;Set process name in banner&quot;)
   184      parser.add_argument(&quot;-p&quot;, dest=&quot;publisher_port&quot;, default='43124',
   185                          help=&quot;Publisher IP port&quot;)
   186      parser.add_argument(&quot;-s&quot;, dest=&quot;subscriber_port&quot;, default='43125',
   187                          help=&quot;Subscriber IP port&quot;)
   188  
   189      args = parser.parse_args()
   190  
   191      subscription_list = args.subscription_list.split(',')
   192  
   193      kw_options = {
   194          'publisher_port': args.publisher_port,
   195          'subscriber_port': args.subscriber_port,
   196          'process_name': args.process_name,
   197      }
   198  
   199      if args.back_plane_ip_address != 'None':
   200          kw_options['back_plane_ip_address'] = args.back_plane_ip_address
   201  
   202      # get the event loop
   203      loop = asyncio.get_event_loop()
   204  
   205      WsGateway(*subscription_list, **kw_options, event_loop=loop)
   206  
   207  
   208  def signal_handler(sig, frame):
   209      print('Exiting Through Signal Handler')
   210      raise KeyboardInterrupt
   211  
   212  
   213  # listen for SIGINT
   214  signal.signal(signal.SIGINT, signal_handler)
   215  signal.signal(signal.SIGTERM, signal_handler)
   216  
   217  if __name__ == '__main__':
   218      ws_gateway()
</code></pre>
<p>Lines 167-219 implement the standard way of instantiating a 
Banyan component.</p>
<h2 id="tcp-gateway">TCP Gateway</h2>
<p>The <a href="https://github.com/MrYsLab/python_banyan/blob/master/python_banyan/utils/tcp_gateway/tcp_gateway.py">TCP gateway</a>
is an example of a specialized Banyan gateway. This gateway was designed to 
permit communication between a Banyan application and any TCP server 
supporting TCP/IP sockets and MessagePack. </p>
<p>Testing of the TCP gateway utilized a TCP server running on Raspberry Pi 
Pico W loaded with MicroPython. MicroPython supports both TCP sockets as well as 
MessagePack.</p>
<p>The TCP gateway is implemented as a TCP client. A command line executable, called tgw, 
is installed when python_banyan is installed. Typically one uses the TCP gateway by 
invoking it through its command line and arguments.</p>
<p>Here are the command-line arguments that tgw supports:</p>
<pre><code class="language-bash">tgw --help
usage: tgw [-h] [-a TCP_IP_ADDRESS] [-b BACK_PLANE_IP_ADDRESS]
           [-e BANYAN_PUB_TOPIC]
           [-g SUBSCRIPTION_LIST [SUBSCRIPTION_LIST ...]] [-l EVENT_LOOP]
           [-n TCP_PORT] [-p PUBLISHER_PORT] [-s SUBSCRIBER_PORT]
           [-z PROCESS_NAME]

options:
  -h, --help            show this help message and exit
  -a TCP_IP_ADDRESS     IP address TCP Server
  -b BACK_PLANE_IP_ADDRESS
                        None or IP address used by Back Plane
  -e BANYAN_PUB_TOPIC   Topic for messages to the host PC
  -g SUBSCRIPTION_LIST [SUBSCRIPTION_LIST ...]
                        Banyan topics space delimited: topic1 topic2 topic3
  -l EVENT_LOOP         asyncio event loop
  -n TCP_PORT           TCP Server Port Number
  -p PUBLISHER_PORT     Publisher IP port
  -s SUBSCRIBER_PORT    Subscriber IP port
  -z PROCESS_NAME       Name of this gateway

</code></pre>
<p><strong>TCP_IP_ADDRESS</strong> is a required parameter. It is the IP address of the TCP server 
assigned by the local router. </p>
<p>The <strong>BACK_PLANE_IP_ADDRESS</strong>, <strong>PUBLISHER_PORT</strong>, and <strong>SUBSCRIBER_PORT</strong> are 
optional parameters 
and are typically not used. Default values are assigned if not specified.</p>
<p><strong>BANYAN_PUB_TOPIC</strong> is the topic used when publishing data to the Banyan network. It has 
a default value of "from_pico."</p>
<p><strong>SUBSCRIPTION_LIST</strong> is the list of topics for messages that the TCP gateway 
processes and passes on to the TCP server. Typically a 
single topic is used, and the default value is "figura."</p>
<p><strong>EVENT_LOOP</strong> is an optional parameter allowing the application to specify an asyncio 
event loop. If none is specified, the TCP gateway will create an asyncio loop.</p>
<p><strong>PROCESS_NAME</strong> has a default value of "TcpGateway." It displays the TCP 
Gateway 
in the application's console window.</p>
<p>Internally, when a subscribed Banyan message arrives, the MessagePack encoded packet 
is enhanced with a length byte. The packet is forwarded to the TCP server to 
perform MessagePack decoding and processing. </p>
<p>When the TCP server wishes to send a message to the Banyan network, it MessagePack 
encodes it and prepends a message length to the message.</p>
<p>The reason for adding a message length is that TCP is a streaming protocol. 
Multiple messages may be combined into a single TCP packet. 
Having a message length assures that messages are appropriately framed.</p>
<p>Also, note that the TCP gateway neither encodes nor 
decodes the messages. Doing so provides better system throughput, 
and encoding and decoding are performed once when needed.</p>
<p>A demo is provided. Follow <a href="https://github.
com/MrYsLab/python_banyan/blob/master/python_banyan/utils/tcp_gateway/Running_Demos.md">this link.</a>
for instructions.</p>
<p><br>
<br>
Copyright (C) 2017-2022 Alan Yorinks All Rights Reserved</p>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../banyan_gateways/" class="md-footer__link md-footer__link--prev" aria-label="Previous: An Introduction To OneGPIO Gateways" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              An Introduction To OneGPIO Gateways
            </div>
          </div>
        </a>
      
      
        
        <a href="../one_gpio_demos/" class="md-footer__link md-footer__link--next" aria-label="Next: OneGPIO Demos" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              OneGPIO Demos
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.a6c66575.min.js"></script>
      
    
  </body>
</html>