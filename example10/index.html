<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Tutorial 10 - Connecting Banyan To An MQTT Network - Python Banyan</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Tutorial 10 - Connecting Banyan To An MQTT Network";
    var mkdocs_page_input_path = "example10.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Python Banyan</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">User's Guide</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../install/">Installation</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Python Banyan By Example</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../examples_intro/">Introduction</a>
                </li>
                <li class="">
                    
    <a class="" href="../example1/">Tutorial 1  - A Simple Echo Server/Client</a>
                </li>
                <li class="">
                    
    <a class="" href="../example2/">Tutorial 2  - Adding Command Line Options To A Component</a>
                </li>
                <li class="">
                    
    <a class="" href="../example3/">Tutorial 3  - Distributed Applications</a>
                </li>
                <li class="">
                    
    <a class="" href="../example4/">Tutorial 4  - Applications From Components On Differing Platforms</a>
                </li>
                <li class="">
                    
    <a class="" href="../example5/">Tutorial 5  - Debugging Using The Monitor</a>
                </li>
                <li class="">
                    
    <a class="" href="../example6/">Tutorial 6  - Integrating With A GUI Event Loop</a>
                </li>
                <li class="">
                    
    <a class="" href="../example7/">Tutorial 7  - Installing Components As Executable Modules</a>
                </li>
                <li class="">
                    
    <a class="" href="../example8/">Tutorial 8  - Using the Banyan Launcher</a>
                </li>
                <li class="">
                    
    <a class="" href="../example9/">Tutorial 9  - Connecting To Multiple Backplanes</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">Tutorial 10 - Connecting Banyan To An MQTT Network</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#connecting-banyan-applications-to-mqtt">Connecting Banyan Applications To MQTT</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#example-1-pure-mqtt-publish-and-subscribe">Example 1: Pure MQTT Publish And Subscribe</a></li>
        
            <li><a class="toctree-l4" href="#example-2-publishing-a-banyan-message-to-the-mqtt-network">Example 2: Publishing a Banyan Message To the MQTT Network</a></li>
        
            <li><a class="toctree-l4" href="#example-3-publishing-an-mqtt-message-to-the-banyan-network">Example 3: Publishing an MQTT Message To the Banyan Network</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../example11/">Tutorial 11 - Physical Computing And GPIO</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../benchmark/">Comparing Banyan and MQTT</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../about/">About</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Python Banyan</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Python Banyan By Example &raquo;</li>
        
      
    
    <li>Tutorial 10 - Connecting Banyan To An MQTT Network</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="connecting-banyan-applications-to-mqtt">Connecting Banyan Applications To MQTT</h1>
<p><img align="center" src="../images/mqtt_gateway.png"></p>
<p>The <a href="https://github.com/MrYsLab/python_banyan/blob/master/python_banyan/utils/mqtt_gateway/mqtt_gateway.py">MQTT Gateway</a>
 is a Banyan component that can subscribe to receive MQTT messages
from the MQTT network, and then forward those messages to the Banyan network.
It also can subscribe to receive Banyan messages, and then forward those to the MQTT network.</p>
<p>The MQTT Gateway is installed as a command line executable when 
Python Banyan is installed. To invoke the MQTT Gateway, open a terminal
window and type:</p>
<p><strong>mgw</strong></p>
<p>There are several optional command line parameters
available in mgw, but for the examples that will follow, the defaults will be accepted.</p>
<p>Here is a list of all the optional parameters.</p>
<pre><code>mgw -h

usage: mqtt_gateway.py [-h] [-a MQTT_IP_ADDRESS] [-b BACK_PLANE_IP_ADDRESS]
                       [-d MQTT_PORT] [-e BANYAN_PUB_TOPIC]
                       [-g BANYAN_SUB_TOPICS [BANYAN_SUB_TOPICS ...]]
                       [-i MQTT_PUB_TOPIC]
                       [-j MQTT_SUB_TOPICS [MQTT_SUB_TOPICS ...]]
                       [-n PROCESS_NAME] [-p PUBLISHER_PORT]
                       [-s SUBSCRIBER_PORT] [-t LOOP_TIME]

optional arguments:
  -h, --help            show this help message and exit
  -a MQTT_IP_ADDRESS    IP address of mqtt broker
  -b BACK_PLANE_IP_ADDRESS
                        None or IP address used by Back Plane
  -d MQTT_PORT          MQTT Port Number
  -e BANYAN_PUB_TOPIC   Topic for messages to MQTT
  -g BANYAN_SUB_TOPICS [BANYAN_SUB_TOPICS ...]
                        Banyan topics space delimited: topic1 topic2 topic3
  -i MQTT_PUB_TOPIC     Topic for messages sent to MQTT
  -j MQTT_SUB_TOPICS [MQTT_SUB_TOPICS ...]
                        MQTT topics space delimited: topic1 topic2 topic3
  -n PROCESS_NAME       Set process name in banner
  -p PUBLISHER_PORT     Publisher IP port
  -s SUBSCRIBER_PORT    Subscriber IP port
  -t LOOP_TIME          Event Loop Timer in seconds

</code></pre>

<p>When the MQTT Gateway is invoked it automatically connects to both the Banyan Backplane and to the MQTT Broker.</p>
<p>Before running the following examples, make sure that you
have a <a href="https://mosquitto.org/">mosquitto broker</a> and a <a href="../examples_intro/#starting-the-backplane">Python Banyan
Backplane</a> running.</p>
<h2 id="example-1-pure-mqtt-publish-and-subscribe">Example 1: Pure MQTT Publish And Subscribe</h2>
<p>This example will publish a simple MQTT message to be received by a simple
MQTT subscriber.</p>
<h3 id="mqtt-publisher">MQTT Publisher</h3>
<p>Below is the code for a simple <a href="https://github.com/MrYsLab/python_banyan/blob/master/examples/mqtt_gateway/pub.py">MQTT publisher</a>
 that publishes a single message and exits.</p>
<pre><code>import json

import paho.mqtt.client as mqtt

# This is a simple MQTT publisher example.
# It connects to an MQTT broker, builds a payload and
# then publishes the message with a topic of &quot;mqtt_network&quot;.

my_client = mqtt.Client()
my_client.connect(&quot;localhost&quot;, 1883, 60)
z = {'from_mqtt_client': 'hello'}

payload = json.dumps(z).encode()
my_client.publish(&quot;mqtt_network&quot;, payload)
my_client.disconnect()
</code></pre>

<h3 id="mqtt-subscriber">MQTT Subscriber</h3>
<p>The <a href="https://github.com/MrYsLab/python_banyan/blob/master/examples/mqtt_gateway/sub.py">MQTT subscriber</a>
 that connects to an MQTT broker,
and subscribes to 2 topics. The <strong>mqtt_network</strong> messages are for messages originated
on the mqtt network. The <strong>from_banyan</strong> messages are messages that were originated on the
Banyan network. For this first example, no messages are originated from the Banyan network.</p>
<pre><code>import paho.mqtt.client as mqtt
import json


# This is a simple MQTT subscriber example.
# It connects to an MQTT broker and
# subscribes to &quot;mqtt_network&quot; messages
# and prints a message when one is received.

def on_connect(client, userdata, flags, rc):
    print(&quot;Connected with result code &quot; + str(rc))
    client.subscribe(&quot;mqtt_network&quot;)
    client.subscribe(&quot;from_banyan&quot;)


def on_message(client, userdata, msg):
    m = msg.payload.decode()
    x = json.loads(m)
    print(x)


my_client = mqtt.Client()
my_client.connect(&quot;localhost&quot;, 1883, 60)

my_client.on_connect = on_connect
my_client.on_message = on_message

my_client.loop_forever()

</code></pre>

<p>First we start the subscriber, and then the publisher. The subscriber prints
any messages it receives. Here is the subscriber console output after
running the publisher:</p>
<pre><code>python3 sub.py
Connected with result code 0
{'from_mqtt_client': 'hello'}

</code></pre>

<h2 id="example-2-publishing-a-banyan-message-to-the-mqtt-network">Example 2: Publishing a Banyan Message To the MQTT Network</h2>
<p>Start the MQTT Gateway by opening a terminal window and typing:
mgw</p>
<p>The Gateway connects to the Python Backplane and to the MQTT broker</p>
<pre><code>$ mgw

************************************************************
MqttGateway using Back Plane IP address: 192.168.2.189
Subscriber Port = 43125
Publisher  Port = 43124
Loop Time = 0.1 seconds
************************************************************
MQTT Gateway Connected to MQTT localhost:1883 with result code 0.

</code></pre>

<p>If it not already running, start the MQTT subsriber, sub.py.</p>
<p>To generate a message from Banyan to the MQTT network, we will use a Banyan component called
<a href="https://github.com/MrYsLab/python_banyan/blob/master/examples/mqtt_gateway/bpub.py">bpub.py:</a></p>
<pre><code>from python_banyan.banyan_base import BanyanBase


class Bpub(BanyanBase):
    &quot;&quot;&quot;
    This class will publish a message for the MqttGateway to forward to the MQTT network.
    &quot;&quot;&quot;

    def __init__(self):
        &quot;&quot;&quot;
        This is constructor for the Bpub class

        &quot;&quot;&quot;

        # initialize the base class
        super(Bpub, self).__init__(process_name='Bpub')

        # send a message to the MqttGateway
        self.publish_payload({'from_banyan': 'hello_mqtt_world'}, 'to_mqtt')

        # exit
        self.clean_up()


b = Bpub()
</code></pre>

<p>If we then start the <em>bpub.py</em> and look at the MQTT Subscriber's output, we see the message
from Banyan was sent out over MQTT and received by the MQTT subscriber:</p>
<pre><code>~/PycharmProjects/python_banyan$ python3 sub.py

Connected with result code 0
{'from_banyan': 'hello_mqtt_world'}
</code></pre>

<p>The gateway received a Banyan message, translated it to an MQTT message, published
this message on the MQTT network and the translated message
was received by the MQTT subscriber.</p>
<h2 id="example-3-publishing-an-mqtt-message-to-the-banyan-network">Example 3: Publishing an MQTT Message To the Banyan Network</h2>
<p>In this example, an MQTT message will be published by pub.py.
The MQTT Gateway will receive this message and it will then translate 
this message to a Banyan message and publish
the message to the Banyan network.</p>
<p>A Banyan component called <a href="https://github.com/MrYsLab/python_banyan/blob/master/examples/mqtt_gateway/bsub.py"><strong>bsub.py</strong></a> 
subscribes to receive the translated message and will publish it to the console.</p>
<p>To run this example, start the MQTT Gateway as we did in
<a href="../example10/#example-2-publishing-a-banyan-message-to-the-mqtt-network">Example 2.</a></p>
<p>Start bsub.py:</p>
<pre><code>python3 bsub.py
</code></pre>

<pre><code>from python_banyan.banyan_base import BanyanBase


class Bsub(BanyanBase):
    &quot;&quot;&quot;
    This class will receive any MQTT messages intercepted by MqttGateway
    &quot;&quot;&quot;

    def __init__(self):
        &quot;&quot;&quot;
        This is constructor for the Bpub class

        &quot;&quot;&quot;

        # initialize the base class
        super(Bsub, self).__init__(process_name='Bsub')

        # subscribe to receive MQTT messages processed
        # by the MqttGateway
        self.set_subscriber_topic('from_mqtt')

        # start the receive_loop
        self.receive_loop()

    def incoming_message_processing(self, topic, payload):
        print(topic, payload)


b = Bsub()

</code></pre>

<p>And finally start the MQTT publisher pub.py</p>
<pre><code>python3 pub.py
</code></pre>

<p>Looking at console for bsub.py we that the message was received from the MQTT
network and received by the Banyan network.</p>
<pre><code>python3 bsub.py

************************************************************
Bsub using Back Plane IP address: 192.168.2.189
Subscriber Port = 43125
Publisher  Port = 43124
Loop Time = 0.1 seconds
************************************************************
from_mqtt {'from_mqtt_client': 'hello'}
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../example11/" class="btn btn-neutral float-right" title="Tutorial 11 - Physical Computing And GPIO">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../example9/" class="btn btn-neutral" title="Tutorial 9  - Connecting To Multiple Backplanes"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../example9/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../example11/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
